@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Trang chủ Admin";
    // Lấy Base URL cho SignalR
    var apiBaseUrl = Configuration["ApiBaseUrl"]?.TrimEnd('/');
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            background-color: #f4f7f6;
            padding-top: 70px; /* Thêm padding-top để tránh bị che bởi header */
        }

        /* --- Thanh điều hướng cố định --- */
        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px;
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed; /* Cố định trên cùng */
            top: 0;
            left: 0;
            right: 0;
            z-index: 1040; /* Dưới modal backdrop (1050) */
        }
        .header-nav .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
        }
        .header-nav .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* --- Container chính --- */
        .main-container {
            padding: 20px;
        }

        .page-title {
            color: #333;
            margin-bottom: 25px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            display: inline-block;
        }

        /* --- Thẻ điều khiển (Cards) --- */
        .dashboard-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Căn đều nội dung */
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.12);
        }
        .dashboard-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
        }
        .dashboard-card .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .dashboard-card .card-text {
            color: #555;
            font-size: 0.95rem;
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }
        .dashboard-card .btn {
            width: 100%;
        }

        /* Card màu sắc khác nhau */
        .card-admin .dashboard-icon { color: #dc3545; } /* Admin - Đỏ */
        .card-admin .btn { background-color: #dc3545; border-color: #dc3545; }
        .card-admin .btn:hover { background-color: #c82333; border-color: #bd2130; }

        .card-analytics .dashboard-icon { color: #fd7e14; } /* Analytics - Cam */
        .card-analytics .btn { background-color: #fd7e14; border-color: #fd7e14; }
        .card-analytics .btn:hover { background-color: #e66b02; border-color: #d96400; }

        .card-news .dashboard-icon { color: #007bff; } /* News - Xanh dương */
        .card-news .btn { background-color: #007bff; border-color: #007bff; }
        .card-news .btn:hover { background-color: #0069d9; border-color: #0062cc; }

        .card-content .dashboard-icon { color: #28a745; } /* Content (Cat/Tag) - Xanh lá */
        .card-content .btn { background-color: #28a745; border-color: #28a745; }
        .card-content .btn:hover { background-color: #218838; border-color: #1e7e34; }


        /* --- Notification Bell (Copy từ file trước) --- */
        .notification-container { position: relative; z-index: 1070; }
        .notification-container .dropdown-menu { min-width: 300px; max-height: 400px; overflow-y: auto; }
        .notification-container .dropdown-item { white-space: normal; font-size: 0.9rem; border-bottom: 1px solid #eee; }
        .notification-container .dropdown-item:last-child { border-bottom: none; }
        .notification-container .dropdown-item a { text-decoration: none !important; color: #333 !important; display: block; padding: .5rem 1rem; }
        .notification-container .dropdown-item a:hover { background-color: #f8f9fa; }
        .notification-container .text-muted { padding: .5rem 1rem; }
        #notification-icon.has-new { color: #dc3545; animation: ring 1.5s ease-in-out infinite; }
        #notification-count { position: absolute; top: -5px; right: -5px; font-size: 0.7em; }
        @@keyframes ring { 0%{transform:rotate(0)} 10%{transform:rotate(14deg)} 20%{transform:rotate(-8deg)} 30%{transform:rotate(14deg)} 40%{transform:rotate(-4deg)} 50%{transform:rotate(10deg)} 60%{transform:rotate(0)} 100%{transform:rotate(0)} }
    </style>
</head>
<body>

    <header class="header-nav">
        <a class="logo" asp-controller="Home" asp-action="AdminIndex">FUNews Admin</a>
        <div class="user-actions">
            <div class="notification-container dropdown">
                <a class="nav-link" href="#" id="notificationDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Thông báo">
                    <i id="notification-icon" class="fas fa-bell fa-lg"></i>
                    <span id="notification-count" class="badge badge-danger badge-pill" style="display: none;"></span>
                </a>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="notificationDropdown" id="notification-list">
                    <li class="dropdown-item text-muted small" id="no-notification-message">Không có thông báo mới</li>
                </ul>
            </div>
            <a href="@Url.Action("Logout", "Account")" class="btn btn-outline-secondary btn-sm">Đăng xuất <i class="fas fa-sign-out-alt"></i></a>
        </div>
    </header>

    <div class="container main-container">
        <h1 class="page-title">Bảng điều khiển Admin</h1>

        <div class="row mb-4">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card card-analytics">
                    <i class="fas fa-chart-line dashboard-icon"></i>
                    <h5 class="card-title">Analytics Dashboard</h5>
                    <p class="card-text">Xem thống kê, biểu đồ và các bài viết thịnh hành.</p>
                    <a asp-controller="Dashboard" asp-action="Index" class="btn btn-primary">Xem Dashboard</a>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card card-news">
                    <i class="fas fa-newspaper dashboard-icon"></i>
                    <h5 class="card-title">Quản lý Tin tức</h5>
                    <p class="card-text">Tạo, sửa, xóa và quản lý các bài viết tin tức.</p>
                    <a asp-controller="NewsArticle" asp-action="Index" class="btn btn-primary">Quản lý Tin tức</a>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card card-admin">
                    <i class="fas fa-users-cog dashboard-icon"></i>
                    <h5 class="card-title">Quản lý Tài khoản</h5>
                    <p class="card-text">Quản lý tài khoản Staff và Lecturer trong hệ thống.</p>
                    <a asp-controller="Account" asp-action="Index" class="btn btn-primary">Quản lý Tài khoản</a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card card-content">
                    <i class="fas fa-folder-open dashboard-icon"></i>
                    <h5 class="card-title">Quản lý Danh mục</h5>
                    <p class="card-text">Tổ chức và phân loại các danh mục tin tức.</p>
                    <a asp-controller="Category" asp-action="Index" class="btn btn-primary">Quản lý Danh mục</a>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card card-content">
                    <i class="fas fa-tags dashboard-icon"></i>
                    <h5 class="card-title">Quản lý Thẻ (Tags)</h5>
                    <p class="card-text">Quản lý các thẻ (từ khóa) cho bài viết.</p>
                    <a asp-controller="Tag" asp-action="Index" class="btn btn-primary">Quản lý Thẻ</a>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-4">
                <div class="dashboard-card card-admin">
                    <i class="fas fa-history dashboard-icon"></i>
                    <h5 class="card-title">Nhật ký Hệ thống</h5>
                    <p class="card-text">Xem lại lịch sử các thay đổi dữ liệu trong hệ thống.</p>
                    <a asp-controller="AuditLog" asp-action="Index" class="btn btn-primary">Xem Nhật ký</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="~/lib/signalr/signalr.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // Toastr config
            toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-top-right", "timeOut": "10000", "extendedTimeOut": "2000" };

            // --- Notification Elements ---
            const notificationIcon = document.getElementById("notification-icon");
            const notificationCount = document.getElementById("notification-count");
            const notificationList = document.getElementById("notification-list");

            // --- Notification Storage (Using sessionStorage) ---
            const MAX_NOTIFICATIONS = 10;
            let recentNotifications = JSON.parse(sessionStorage.getItem('recentNotifications') || '[]');
            let unreadCount = parseInt(sessionStorage.getItem('unreadNotificationCount') || '0');

            // --- Function to add a notification ---
            function addRecentNotification(notification) {
                recentNotifications.unshift(notification);
                if (recentNotifications.length > MAX_NOTIFICATIONS) recentNotifications.pop();
                sessionStorage.setItem('recentNotifications', JSON.stringify(recentNotifications));

                if (!$('#notificationDropdown').parent().hasClass('show')) {
                     unreadCount++;
                     sessionStorage.setItem('unreadNotificationCount', unreadCount.toString());
                }
                updateNotificationUI();
            }

            // --- Function to update the bell dropdown UI ---
            function updateNotificationUI() {
                if (!notificationList || !notificationIcon || !notificationCount) return;
                notificationList.innerHTML = '';
                if (recentNotifications.length === 0) {
                    notificationList.innerHTML = '<li class="dropdown-item text-muted small" id="no-notification-message">Không có thông báo mới</li>';
                    notificationIcon.classList.remove('has-new');
                    notificationCount.style.display = 'none';
                    return;
                }
                recentNotifications.forEach(noti => {
                    const listItem = document.createElement('li');
                    const linkTarget = noti.articleUrl ? 'target="_blank"' : '';
                    const href = noti.articleUrl || '#';
                    const link = document.createElement('a');
                    link.className = 'dropdown-item small';
                    link.href = href;
                    if(noti.articleUrl) link.target = "_blank";
                    const messageSpan = document.createElement('span');
                    messageSpan.textContent = noti.message;
                    messageSpan.style.fontWeight = "bold";
                    const timeSpan = document.createElement('small');
                    timeSpan.className = 'd-block text-muted';
                    timeSpan.textContent = noti.timestamp ? new Date(noti.timestamp).toLocaleString("vi-VN") : new Date().toLocaleString("vi-VN");
                    link.appendChild(messageSpan);
                    link.appendChild(timeSpan);
                    listItem.appendChild(link);
                    notificationList.appendChild(listItem);
                });
                if (unreadCount > 0) {
                     notificationIcon.classList.add('has-new');
                     notificationCount.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
                     notificationCount.style.display = 'inline-block';
                } else {
                     notificationIcon.classList.remove('has-new');
                     notificationCount.style.display = 'none';
                }
            }

            // --- Event: Reset unread count when dropdown is opened ---
            $('#notificationDropdown').on('show.bs.dropdown', function () {
                unreadCount = 0;
                sessionStorage.setItem('unreadNotificationCount', '0');
                updateNotificationUI();
            });

            // --- SignalR Connection ---
            const signalRHubUrl = "@(apiBaseUrl)/hubs/notifications";
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(signalRHubUrl)
                .configureLogging(signalR.LogLevel.Warning)
                .withAutomaticReconnect()
                .build();

            // --- Event: Listen for "ReceiveNotification" from Hub ---
            connection.on("ReceiveNotification", (data) => {
                console.log("📢 Notification received:", data);
                if (!data || !data.message) return;
                const notification = { message: data.message, articleUrl: data.articleUrl, timestamp: new Date().toISOString() };
                let toastMessage = notification.message;
                if (notification.articleUrl) {
                    toastMessage = `<a href="${notification.articleUrl}" target="_blank" style="color: white; text-decoration: underline;">${notification.message}</a>`;
                }
                toastr.success(toastMessage, 'Thông báo mới!');
                addRecentNotification(notification);
            });

            // --- Start Connection ---
            async function startSignalRConnection() {
                try {
                    await connection.start();
                    console.log("✅ SignalR connected to", signalRHubUrl);
                } catch (err) {
                    console.error("❌ SignalR connection error:", err);
                    setTimeout(startSignalRConnection, 5000);
                }
            }
            connection.onclose(async () => { console.log("SignalR Connection Closed. Reconnecting..."); });

            startSignalRConnection();
            updateNotificationUI(); // Initial UI update

        });
    </script>
</body>
</html>